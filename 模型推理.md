# 模型推理

## 模型支持列表

<table>
    <thead>
        <tr>
            <th>模型类型</th>
            <th>任务类型</th>
            <th>模型列表</th>
            <th>支持尺寸</th>
            <th>CPU适配</th>
            <th>NPU适配</th>
            <th>模型详情</th>
            <th>SDK连接</th>
        </tr>
    </thead>
    <tbody>    
        <tr>
            <td>clas_resnet</td>
            <td>图片分类</td>
            <td>ResNet18<br>ResNet34<br>ResNet50</td>
            <td>224x224</td>
            <td>是</td>
            <td>是</td>
            <td><a href="https://github.com/PaddlePaddle/PaddleClas/blob/release/2.5/docs/zh_CN/models/ImageNet1k/model_list.md#resnet-%E7%B3%BB%E5%88%97-1">模型详情</a></td>
            <td><a href="https://bj.bcebos.com/ppdeploy/ppdeploy1.0/PPDeploy1.0_resnet_PaddleClas2.5_Paddle2.2.2_Ver1.0.0.zip">下载链接</a></td>
        </tr>
        <tr>
            <td>det_yolov3</td>
            <td>目标检测</td>
            <td>YOLOv3-Mobilenet-V1<br>YOLOv3-DarkNet53<br>YOLOv3-ResNet34</td>
            <td>320x320<br>416x416<br>608x608</td>
            <td>是</td>
            <td>是</td>
            <td><a href="https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.6/configs/yolov3#yolov3">模型详情</a></td>
            <td><a href="https://bj.bcebos.com/ppdeploy/ppdeploy1.0/PPDeploy1.0_yolov3_PaddleDetection2.6_Paddle2.2.2_Ver1.0.0.zip">下载链接</a></td>
        </tr>
        <tr>
            <td>kpt_hrnet</td>
            <td>人体关键点检测</td>
            <td>HRNet-w32</td>
            <td>256x192<br>384x288</td>
            <td>是</td>
            <td>是</td>
            <td><a href="https://github.com/PaddlePaddle/PaddleDetection/tree/release/2.6/configs/keypoint#%E6%A8%A1%E5%9E%8B%E5%BA%93">模型详情</a></td>
            <td><a href="https://bj.bcebos.com/ppdeploy/ppdeploy1.0/PPDeploy1.0_PoseDeploy_PaddleDetection2.6_Paddle2.2.2_Ver1.0.0.zip">下载链接</a></td>
        </tr>
    </tbody>    
</table>

## AI项目流程概述

AI项目流程大致为**确定应用场景和目标**、
**数据收集和预处理**、
**选择或设计AI模型**、
**模型训练**、
**模型评估**、
**模型导出**、
**模型部署**多个步骤。  
其中确定应用场景和目标、数据收集和预处理、选择或设计AI模型、模型训练、模型评估、模型导出前几个环节又可统称为**模型生产**，参考[百度飞桨PaddlePaddle](https://github.com/PaddlePaddle)系列的相关开源项目，本文档重点展开和EdgeBoard DK-1A更加密切的模型部署环节。

## 例：clas_resnet

本例中，使用ResNet模型对图片进行分类。  

### 模型说明

该模型用于目标检测任务，基于PaddleClass2.5进行模型训练，paddle版本使用2.4.1，输入数据尺寸为224x224，数据格式为Imagenet格式。

### 效果预览

输入图片： ./test_images/ILSVRC2012_val_00000014.JPEG  
![测试图片](./images/clas_resnet_test.jpeg)  

输出结果： ./vis.jpg 图片(图片左上角被标注“label = 757”，表示该图片属于“757”类，即“救护车”)。  
![测试结果](./images/clas_resnet_result.jpeg)  

### 模型生产

基于AIStudio中的范例项目[基于ResNet进行物品分类](https://aistudio.baidu.com/projectdetail/7153172?contributionType=1&sUid=1318783&shared=1&ts=1701053232435)进行模型的训练、评估和导出。(版本参考：ver23.11.28 2023-11-28 19:04:02)

### 模型部署

Step1：安装EdgeBoard DK-1A推理工具PPNC(如已安装，可跳过此步)  
打开终端，执行以下命令安装PPNC。

```shell
sudo apt update
sudo apt install ppnc-runtime
```

Step2：安装PaddlePaddle(如已安装，可跳过此步)  
打开终端，执行以下命令安装PaddlePaddle。

```shell
cd Downloads
wget https://bj.bcebos.com/pp-packages/whl/paddlepaddle-2.4.2-cp38-cp38-linux_aarch64.whl  
pip install paddlepaddle-2.4.2-cp38-cp38-linux_aarch64.whl
```

Step3：模型转化

为保证模型部署在EdgeBoard DK-1A上能够更高效率运行，充分调用板卡的CPU、GPU、NPU算力，需要将模型进行特定高性能转化。

自行训练获得标准模型后，可联系[百度技术支持]()进行模型高性能转化。

Step4：下载模型

此例中下载范例项目已转化好的模型。在EdgeBoard DK-1A上打开终端，执行以下命令下载模型及相关物料。

```shell
cd /home/edgeboard/
sudo wget https://bj.bcebos.com/ppdeploy/ppdeploy1.1/SDK/PPDeploy1.1_resnet_PaddleClas2.5_Paddle2.4.1_Ver1.0.0_python.zip
```

Step3：解压文件。

```shell
unzip PPDeploy1.1_resnet_PaddleClas2.5_Paddle2.4.1_Ver1.0.0_python.zip
```

Step4：将模型相关文件移动至默认文件夹  
将解压出来的model文件夹置于/home/edgeboard/目录下。

```shell
cd /home/edgeboard/Downloads/resnet-model/
mv model /home/edgeboard
```

Step5：配置config.json文件  
默认已配置完成，可直接使用，如有自定义，可另行更改配置内容。

```json
    {
        "mode": "professional",     //固定字段无需修改
        "model_dir": "./model",     //模型文件路径 
        "model_file": "model"       //固定为model，无需修改
    }
```

Step4-3_Python：运行推理代码。

```shell
cd /home/edgeboard
python3 tools/infer_demo.py \ 
--config ./model/config.json \ 
--test_image ./test_images/ILSVRC2012_val_00000014.JPEG
```

> **参数说明**
>
> - config:         上文建立的config.json的路径
> - test_image:     测试图片路径
> - visualize:      是否可视化，若设置则会在该路径下生成vis.jpg渲染结果，默认不生成
> - with_profile:   是否统计前处理、模型推理、后处理各阶段耗时，若设置会输出各阶段耗时，默认不输出  
>  

Step4-4_Python：查看推理结果。
在

#### C++部署
